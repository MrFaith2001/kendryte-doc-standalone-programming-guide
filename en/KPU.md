# KPU

## Overview

Knowledge Processing Unit (KPU, aka Neural network Processing Unit).

KPU is a general-purpose neural network processor that implements convolutional neural network calculations with low power consumption.
It can acquire the size, coordinates and types of detected objects in real time, and detect and classify faces or objects.
When using kpu, the neural network model must be generated with the model compiler.

## Features

KPU has the following characteristics:

- Supports the fixed training model that the common training framework trains according to specific restriction rules
- There is no direct limit on the number of network layers, which supports separate configuration of each layer of convolutional neural network parameters, including the number of input and output channels, input and output line width and column height.
- Support for two convolution kernels 1x1 and 3x3
- Support for any form of activation function
- The maximum supported neural network parameter size in real-time work is 5.5MiB to 5.9MiB
- Maximum support network parameter size when working in non-real time is (Flash capacity) - (software size)

## API

Corresponding header file `kpu.h`

Provide the following interfaces

- kpu\_task\_init

- kpu\_run

- kpu\_get\_output\_buf

- kpu\_release\_output\_buf

### kpu\_task\_init

#### Description

Initialize the kpu task handle, which is implemented in the gencode_output.c generated by the model compiler.

#### Function prototype

```c
kpu_task_t* kpu_task_init(kpu_task_t* task)
```

#### Parameter

| Parameter name |   Description   | Input or output |
| -------------- | --------------- | --------------- |
| task           | KPU task handle | Input           |

#### Return value

KPU task handle.

### kpu\_run

#### Description

Start the KPU and perform the AI operation.

#### Function prototype

```c
int kpu_run(kpu_task_t* v_task, dmac_channel_number_t dma_ch, const void *src, void* dest, plic_irq_callback_t callback)
```

#### Parameter

| Parameter name |              Description               | Input or output |
| -------------- | -------------------------------------- | --------------- |
| task           | KPU task handle                        | Input           |
| dma\_ch        | DMA channel                            | Input           |
| src            | Input image data                       | Input           |
| dest           | Operation output                       | Output          |
| callback       | Operation completion callback function | Input           |

#### Return value

| Return value |    Description    |
| :----------- | :---------------- |
| 0            | Success           |
| Others       | KPU is busy. Fail |

### kpu\_get\_output\_buf

#### Description

Get a buffer of KPU output results.

#### Function prototype

```c
uint8_t *kpu_get_output_buf(kpu_task_t* task)
```

#### Parameter

| Parameter name |   Description   | Input or output |
| -------------- | --------------- | --------------- |
| task           | KPU task handle | Input           |

#### Return value

A pointer to the buffer of the KPU output.

### kpu\_release\_output\_buf

#### Description

Release the KPU output result buffer.

#### Function prototype

```c
void kpu_release_output_buf(uint8_t *output_buf)
```

#### Parameter

| Parameter name |       Description        | Input or output |
| -------------- | ------------------------ | --------------- |
| output\_buf    | KPU output result buffer | Input           |

#### Return value

None.

## Data type

The relevant data types and data structures are defined as follows:

- kpu\_task\_t: KPU task structure.

### kpu\_task\_t

#### Description

KPU task structure.

#### Type definition

```c
typedef struct
{
    kpu_layer_argument_t* layers;
    uint32_t length;
    int dma_ch;
    uint64_t* dst;
    uint32_t dst_length;
    plic_irq_callback_t cb;
} kpu_task_t;
```

#### Enumeration element

| Element name |              Description               |
| ------------ | -------------------------------------- |
| layers       | KPU parameter pointer                  |
| length       | Number of layers                       |
| dma_ch       | DMA channel                            |
| dst          | Operation result output buffer pointer |
| dst_length   | Operation result output buffer length  |
| cb           | Operation completion callback function |